<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Postcard PDF Creator</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
    max-width: 600px;
    position: relative;
    margin: 0 auto;
    max-width: 800px;
  }
  h2, h3 {
    color: #333;
  }
  label {
    display: block;
    margin-top: 15px;
  }
  input, textarea, button {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    font-size: 1em;
    box-sizing: border-box;
    border-radius: 4px;
    border: 1px solid #aaa;
    font-family: Arial, sans-serif;
  }
  textarea {
    height: 80px;
    resize: vertical;
  }
  button {
    margin-top: 20px;
    background-color: #007bff;
    color: white;
    border: none;
    cursor: pointer;
  }
  button:hover {
    background-color: #0056b3;
  }
  .section {
    background: #f9f9f9;
    border-radius: 6px;
    padding: 15px;
    margin-top: 20px;
    box-shadow: 0 2px 5px #ccc;
  }
</style>
</head>
<body>

<form id="postcardForm">
  <div class="section">
    <h3>Front Side</h3>
    <label>Upload Image (Full Front Side): <a href="https://unsplash.com/" target="_blank">Get images here</a>
      <input type="file" id="frontImage" accept="image/*" required />
    </label>
  </div>

  <div class="section">
    <h3>Back Side</h3>
    <label>
      <input type="text" id="backHeader" placeholder="Header / Title" required />
    </label>
    <label>
      <textarea id="backContent" placeholder="Enter content here" required></textarea>
    </label>
    <label>
      <input type="text" id="backName" placeholder="Enter your name here" required />
    </label>
    <label>
      <input type="text" id="backPhone" placeholder="Enter phone number here" required />
    </label>
    <label>
      <input type="text" id="backWebsite" placeholder="enter website here" required />
    </label>
    <label>Logo Image:
      <input type="file" id="backLogo" accept="image/*" required />
    </label>
  </div>

  <button type="button" onclick="generatePDF()">Generate PDF</button>
</form>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.3/jspdf.umd.min.js"></script>
<script>
 async function generatePDF() {
  try {
    const { jsPDF } = window.jspdf;

    const backHeader = safeString(document.getElementById("backHeader").value);
    const backContent = safeString(document.getElementById("backContent").value);
    const backName = safeString(document.getElementById("backName").value);
    const backPhone = safeString(document.getElementById("backPhone").value);
    const backWebsite = safeString(document.getElementById("backWebsite").value);

    const frontImageFile = document.getElementById("frontImage").files[0];
    if (!frontImageFile) {
      alert("Please upload front side image.");
      return;
    }
    const frontImgData = await getBase64(frontImageFile);

    const backLogoFile = document.getElementById("backLogo").files[0];
    if (!backLogoFile) {
      alert("Please upload back side logo image.");
      return;
    }
    const backLogoData = await getBase64(backLogoFile);

    const doc = new jsPDF({ unit: "in", format: [7, 5], orientation: "landscape" });

    // Front page: full image 7 x 5
    doc.addImage(frontImgData, "JPEG", 0, 0, 7, 5);

    doc.addPage();

    // Vertical dividing line at 3.5 inch
    doc.setDrawColor(0);
    doc.setLineWidth(0.01);
    doc.line(3.5, .3, 3.5, 4.8);

    const paddingLeft = 0.3;
    const maxTextWidth = 3.5 - 2 * paddingLeft; // left side content width minus padding

    // Header and content at top
    let y = 0.5;
    doc.setFont("helvetica", "normal");
    doc.setFontSize(20);
    doc.text(backHeader, paddingLeft, y, { maxWidth: maxTextWidth });

    y += 0.25;
    doc.setFontSize(10);
    doc.text(backContent, paddingLeft, y, { maxWidth: maxTextWidth });

    // Position Name, Phone, Website stacked at bottom with no gaps
    const pageHeight = 5;
    const bottomMargin = 1;
    const fontSizePt = 10;
    const fontSizeInches = fontSizePt / 60;

    // Calculate y for stacked lines from bottom
    const yWebsite = pageHeight - bottomMargin;
    const yPhone = yWebsite - fontSizeInches;
    const yName = yPhone - fontSizeInches;

    doc.setFontSize(fontSizePt);
    doc.text(`${backName}`, paddingLeft, yName);
    doc.text(`${backPhone}`, paddingLeft, yPhone);
    doc.text(`${backWebsite}`, paddingLeft, yWebsite);

    // Calculate logo width based on fixed height preserving aspect ratio
    const logoFixedHeightInches = 0.75; // fixed logo height
    const dimensions = await loadImageDimensions(backLogoData);
    const scaledWidth = (dimensions.width / dimensions.height) * logoFixedHeightInches;

    // Logo image just below Website line with a small gap
    const logoGap = 0.1;
    const yLogo = yWebsite + logoGap;

    doc.addImage(backLogoData, "PNG", paddingLeft, yLogo, scaledWidth, logoFixedHeightInches);

    // Open PDF in new tab instead of downloading
    const pdfBlob = doc.output("blob");
    const url = URL.createObjectURL(pdfBlob);
    window.open(url, "_blank");

    setTimeout(() => URL.revokeObjectURL(url), 10000);
  } catch (err) {
    console.error("Error during PDF generation: ", err);
    alert("An error occurred while generating the PDF. See console for details.");
  }
}

// Helper functions
function safeString(value) {
  return value ? String(value) : "";
}

async function getBase64(file) {
  return new Promise((resolve, reject) => {
    if (!file) {
      reject(new Error("No file provided"));
      return;
    }
    const reader = new FileReader();
    reader.onerror = () => reject(new Error("Failed to read file!"));
    reader.onload = () => resolve(reader.result);
    reader.readAsDataURL(file);
  });
}

function loadImageDimensions(base64Img) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = function () {
      resolve({ width: img.naturalWidth, height: img.naturalHeight });
    };
    img.onerror = reject;
    img.src = base64Img;
  });
}

</script>

</body>
</html>
